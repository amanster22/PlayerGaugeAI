import { useState, useEffect } from 'react';
import logo from './logo.svg';

function App() {
  const [featuredPlayer, setFeaturedPlayer] = useState(null);
  const [question, setQuestion] = useState("");
  const [response, setResponse] = useState("");

  useEffect(() => {
    fetch('http://localhost:5000/api/featured-player')
      .then((res) => res.json())
      .then((data) => setFeaturedPlayer(data))
      .catch((err) => console.error("Error fetching player data:", err));
  }, []);

  const handleAskAI = async () => {
  if (!question.trim()) return;

  try {
    // Step 1: Get SQL from Mistral
    const aiRes = await fetch("https://api.mistral.ai/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer Lreh85pOjfLtK0MtVxOj7RBsUKqoTadO`
      },
      body: JSON.stringify({
        model: "mistral-small",
        messages: [
          {
            role: "system",
            content: "Your job is to review the provided schema for the table named player_data and return the correct SQL query depending on the question. The schema includes the following features: PLAYER_ID, PLAYER_NAME, NICKNAME, TEAM_ID, TEAM_ABBREVIATION, AGE, GP, W, L, W_PCT, MIN, FGM, FGA, FG_PCT, FG3M, FG3A, FG3_PCT, FTM, FTA, FT_PCT, OREB, DREB, REB, AST, TOV, STL, BLK, BLKA, PF, PFD, PTS, PLUS_MINUS, NBA_FANTASY_PTS, DD2, TD3, WNBA_FANTASY_PTS, GP_RANK, W_RANK, L_RANK, W_PCT_RANK, MIN_RANK, FGM_RANK, FGA_RANK, FG_PCT_RANK, FG3M_RANK, FG3A_RANK, FG3_PCT_RANK, FTM_RANK, FTA_RANK, FT_PCT_RANK, OREB_RANK, DREB_RANK, REB_RANK, AST_RANK, TOV_RANK, STL_RANK, BLK_RANK, BLKA_RANK, PF_RANK, PFD_RANK, PTS_RANK, PLUS_MINUS_RANK, NBA_FANTASY_PTS_RANK, DD2_RANK, TD3_RANK, WNBA_FANTASY_PTS_RANK, SALARY, PPG, RPG, APG, PREDICTED_SALARY, SALARY_DIFF, and SALARY_PCT_CHANGE. If a question cannot be answered using only these features from the schema, you must admit that you do not know. Just return the SQL query string, nothing else no need to explain what the query brings, just start with 'SELECT', 'FROM' will always be 'player_data'  and end with ';'."
          },
          { role: "user", content: question }
        ]
      })
    });

    const aiData = await aiRes.json();
    const sqlQuery = aiData.choices[0]?.message?.content.trim();

    console.log("AI-generated SQL:", sqlQuery);

    if (!sqlQuery.toLowerCase().startsWith("select")) {
      setResponse("Invalid query generated by AI.");
      return;
    }

    // Step 2: Send SQL to backend
    const dbRes = await fetch("http://localhost:5000/api/query", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ query: sqlQuery })
    });

    const dbData = await dbRes.json();

    if (dbData.error) {
      setResponse(`SQL Error: ${dbData.error}`);
    } else {
      setResponse(JSON.stringify(dbData.results, null, 2));
    }
  } catch (error) {
    console.error("Error:", error);
    setResponse("There was an error processing your request.");
  }
};


  return (
    <div className="font-titillium bg-blue-900 text-white pt-20">
      {/* Navbar */}
      <nav className="bg-blue-800 shadow-md fixed top-0 w-full z-50">
        <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
          <a href="#home" className="flex items-center">
            <img
              src={logo}
              alt="Logo"
              className="w-40 md:w-56 transition duration-300 hover:brightness-0 hover:invert hover:sepia hover:hue-rotate-[330deg] hover:saturate-[5] hover:contrast-[1.2]"
            />
          </a>
          <ul className="flex gap-6 text-white font-semibold">
            <li><a href="#home" className="hover:text-orange-400">Home</a></li>
            <li><a href="#players" className="hover:text-orange-400">Players</a></li>
            <li><a href="#teams" className="hover:text-orange-400">Teams</a></li>
            <li><a href="#analytics" className="hover:text-orange-400">Analytics</a></li>
            <li><a href="#about" className="hover:text-orange-400">About</a></li>
          </ul>
        </div>
      </nav>

      {/* Home Section */}
      <section id="home" className="min-h-screen flex flex-col items-center justify-center text-center px-6 bg-gradient-to-br from-blue-900 to-blue-700">
        <h1 className="text-5xl font-bold mb-4">AI-Powered NBA Player Evaluator</h1>
        <p className="text-lg text-blue-200 mb-6">Ask our chatbot to evaluate performance, salary fit, and player trends.</p>
        <div className="w-full max-w-xl bg-white text-black rounded-xl shadow-lg p-6">
          <h2 className="text-2xl font-semibold mb-4">Ask the AI</h2>
          <textarea
            value={question}
            onChange={(e) => setQuestion(e.target.value)}
            placeholder="What would be the fair salary for Tyrese Maxey's current performance?"
            className="w-full p-3 border border-gray-300 rounded-md mb-4 resize-none"
          ></textarea>
          <button
            onClick={handleAskAI}
            className="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded"
          >
            Send
          </button>

          {response && (
            <div className="mt-4 text-left">
              <h3 className="text-lg font-semibold">AI Response:</h3>
              <p className="text-sm text-gray-800 mt-1 whitespace-pre-wrap">{response}</p>
            </div>
          )}
        </div>
      </section>

      {/* Players Section */}
      <section id="players" className="py-20 bg-blue-800 px-6">
        <div className="max-w-6xl mx-auto">
          <h2 className="text-4xl font-bold text-center mb-10">Player Evaluations</h2>
          <div className="max-w-3xl mx-auto text-center mb-16">
            <h3 className="text-3xl font-semibold text-orange-400 mb-6">Today's Featured Player</h3>
            {featuredPlayer ? (
              <div className="bg-white text-black rounded-xl shadow-md p-6 text-left">
                <h4 className="text-2xl font-bold mb-2">{featuredPlayer.PLAYER_NAME}</h4>
                <ul className="text-sm mb-4">
                  <li><strong>Team:</strong> {featuredPlayer.TEAM_ABBREVIATION}</li>
                  <li><strong>PPG:</strong> {featuredPlayer.PPG}</li>
                  <li><strong>APG:</strong> {featuredPlayer.APG}</li>
                  <li><strong>RPG:</strong> {featuredPlayer.RPG}</li>
                  <li><strong>Age:</strong> {featuredPlayer.AGE}</li>
                </ul>
                <p className="text-base font-semibold text-orange-500">Estimated Salary: ${featuredPlayer.PREDICTED_SALARY}M</p>
                <p className="text-sm text-gray-700 mt-2">Based on recent performance and league trends.</p>
              </div>
            ) : (
              <p className="text-blue-200">Loading player data...</p>
            )}
          </div>
        </div>
      </section>

      {/* Teams Section */}
      <section id="teams" className="py-20 bg-blue-900 px-6">
        <div className="max-w-6xl mx-auto">
          <h2 className="text-4xl font-bold text-center mb-10">Team Insights</h2>
          {/* Cards omitted for brevity */}
        </div>
      </section>

      {/* Analytics Section */}
      <section id="analytics" className="py-20 bg-gradient-to-br from-blue-800 to-blue-600 px-6">
        <div className="max-w-6xl mx-auto text-center">
          <h2 className="text-4xl font-bold mb-6">Analytics Dashboard</h2>
          {/* Cards omitted for brevity */}
        </div>
      </section>

      {/* About Section */}
      <section id="about" className="py-20 bg-blue-950 px-6">
        <div className="max-w-4xl mx-auto text-center">
          <h2 className="text-4xl font-bold text-orange-400 mb-4">About PlayerGaugeAI</h2>
          <p className="text-blue-200 text-lg mb-6">PlayerGaugeAI is an intelligent NBA analytics platform built to bridge the gap between machine learning and everyday fans...</p>
        </div>
      </section>

      {/* Footer */}
      <footer className="bg-blue-800 text-center py-6">
        <p className="text-blue-300">&copy; 2025 PlayerGaugeAI. All rights reserved.</p>
      </footer>
    </div>
  );
}

export default App;
